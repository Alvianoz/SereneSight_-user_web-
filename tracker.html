<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tracking</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background: linear-gradient(180deg,#f0f2f5 1%, #6a63a4 100%);
        color: #333;
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
      }

      /* Header */
      .header {
        margin-top: 12px;
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 8px 18px;
        border-radius: 8px;
      }

      .logo {
        display: flex;
        align-items: center;
      }

      .logo h1 {
        color: #2d3748;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
      }

      .logo h1 i {
        color: #48bb78;
        margin-right: 0.5rem;
      }

      .logo img {
        width: 45px;
        height: 45px;
        margin-right: 10px;
        vertical-align: middle;
      }

      .user-menu {
        display: flex;
        align-items: center;
      }

      .user-menu .icon-btn {
        background: none;
        border: none;
        font-size: 1.2rem;
        color: #4a5568;
        margin-left: 1rem;
        cursor: pointer;
      }

      .user-menu .icon-btn:hover {
        color: #48bb78;
      }

      .signout-btn {
        padding: 10px 15px;
        background-color: #6a63a4;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        margin-left: 12px;
        cursor: pointer;
      }

      .signout-btn:hover {
        background-color: #6d28d9;
        transition: all 0.3s ease;
      }

      .start-btn:hover {
        background-color: #6d28d9;
        transition: all 0.3s ease;
      }

      .start-btn {
        padding: 10px 15px;
        background-color: #6a63a4;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        width: 100%;
        margin-bottom: 1rem;
      }

      /* Main Content */
      .main-content {
        padding: 2rem 0;
      }

      .page-title {
        margin-bottom: 2rem;
      }

      .page-title h2 {
        color: #2d3748;
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
      }

      .page-title p {
        color: #718096;
        font-size: 0.9rem;
      }

      /* Health Overview Cards */
      .health-overview {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .card {
        width: 100%;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .card-title {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
        color: #4a5568;
        font-weight: 500;
      }

      .card-title i {
        margin-right: 0.5rem;
      }

      .card-value {
        font-size: 1.7rem;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 0.5rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
      }

      .card-subtitle {
        font-size: 0.875rem;
        color: #718096;
      }

      /* Navigation */
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: #fff;
        display: flex;
        justify-content: space-around;
        padding: 0.75rem 0;
        box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
      }

      .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        color: #a0aec0;
      }

      .nav-item.active4 {
        color: #6a63a4;
      }

      .nav-item i {
        font-size: 1.25rem;
        margin-bottom: 0.25rem;
      }

      .nav-text {
        font-size: 0.75rem;
      }

      .profile-pic {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        margin-right: 10px;
        margin-bottom: 1rem;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .health-overview {
          grid-template-columns: 1fr 1fr;
        }
        .video-container {
          flex-direction: column;
          align-items: center;
          width: 100%;
        }
        #video,
        #canvas {
          width: 100% !important;
          height: auto !important;
          max-width: 100vw;
        }
        .controls {
          flex-direction: column;
          align-items: center;
          gap: 12px;
          width: 100%;
        }
      }

      @media (max-width: 480px) {
        .health-overview {
          grid-template-columns: 1fr;
        }
        .logo h1 {
          display: none;
        }
      }

      /* Tracking */

      .status {
        text-align: center;
        margin: 20px 0;
        font-size: 18px;
        font-weight: bold;
        color: #6a63a4;
      }

      .status.loading {
        color: #ffc107;
      }
      .status.ready {
        color: #48bb78;
      }
      .status.error {
        color: #f44336;
      }

      .video-container {
        position: relative;
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
      }

      #video {
        width: 640px;
        height: 480px;
        border-radius: 16px;
        box-shadow: 0 4px 15px rgba(106, 99, 164, 0.12);
        transform: scaleX(-1);
        background: #f0f2f5;
      }

      #canvas {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
        border-radius: 16px;
        transform: scaleX(-1);
      }

      .controls {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 30px;
      }

      .btn {
        padding: 12px 28px;
        border: none;
        border-radius: 10px;
        font-size: 15px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 2px 8px #e0e0e0;
      }

      .btn-primary {
        background: linear-gradient(90deg, #6a63a4 60%, #48bb78 100%);
        color: white;
      }
      .btn-danger {
        background: linear-gradient(90deg, #e96443 60%, #904e95 100%);
        color: white;
      }
      .btn-secondary {
        background: linear-gradient(90deg, #43cea2 60%, #185a9d 100%);
        color: white;
      }
      .btn:hover {
        transform: translateY(-2px) scale(1.04);
        box-shadow: 0 6px 18px #e0e0e0;
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 24px;
        margin-bottom: 30px;
      }

      .emotion-panel,
      .face-info,
      .history-panel {
        background: rgba(255, 255, 255, 0.97);
        border-radius: 16px;
        padding: 24px 18px;
        box-shadow: 0 4px 24px rgba(44, 62, 80, 0.1);
        backdrop-filter: blur(2px);
      }

      .emotion-panel h3,
      .face-info h3,
      .history-panel h3 {
        margin-bottom: 15px;
        color: #6a63a4;
        text-align: center;
        font-weight: 700;
      }

      .emotion-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 10px 0;
        padding: 10px 14px;
        background: #6a63a4;
        border-radius: 10px;
        font-size: 1.05em;
        font-weight: 500;
        box-shadow: 0 2px 8px rgba(106, 99, 164, 0.08);
        color: #e2e8f0;
      }

      .emotion-name {
        font-weight: bold;
        text-transform: capitalize;
      }

      .emotion-value {
        font-size: 14px;
        color: #6a63a4;
        min-width: 38px;
        text-align: right;
      }

      .emotion-bar {
        width: 100px;
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
        margin: 0 10px;
      }

      .emotion-fill {
        height: 100%;
        border-radius: 4px;
        background: linear-gradient(90deg, #6a63a4 0%, #48bb78 100%);
        transition: width 0.3s ease;
      }

      .emotion-item:nth-child(2) .emotion-fill {
        background: linear-gradient(90deg, #f7971e, #ffd200);
      }
      .emotion-item:nth-child(3) .emotion-fill {
        background: linear-gradient(90deg, #e96443, #904e95);
      }
      .emotion-item:nth-child(4) .emotion-fill {
        background: linear-gradient(90deg, #fc5c7d, #6a82fb);
      }
      .emotion-item:nth-child(5) .emotion-fill {
        background: linear-gradient(90deg, #43cea2, #185a9d);
      }
      .emotion-item:nth-child(6) .emotion-fill {
        background: linear-gradient(90deg, #43e97b, #38f9d7);
      }

      .face-metric {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 10px 0;
        padding: 10px 14px;
        background: #6a63a4;
        border-radius: 10px;
        font-size: 1.05em;
        font-weight: 500;
        box-shadow: 0 2px 8px rgba(106, 99, 164, 0.08);
        color: #e2e8f0;
      }

      .history-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #e2e8f0;
        font-size: 1em;
        color: #4a2563;
      }
      .timestamp {
        font-size: 12px;
        color: #888;
      }
      .dominant-emotion {
        font-weight: bold;
        color: #6a63a4;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="container">
        <div class="header-content">
          <div class="logo">
            <img src="file.jpg" alt="Logo" />
            <h1>Serene Sight</h1>
          </div>

          <div class="user-menu">
            <button class="icon-btn" id="notificationBtn">
              <i class="fas fa-bell"></i>
            </button>
            <button class="icon-btn" id="profileBtn">
              <i class="fas fa-user"></i>
            </button>
            <button
              class="signout-btn"
              id="signOutBtn"
              onclick="window.location.href='index.html'"
            >
              Sign Out
              <i class="fas fa-sign-out-alt"></i>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <div class="container">
        <div class="page-title">
          <h2>Emotion Tracker</h2>
        </div>

        <div class="health-overview">
          <div class="card">
            <div class="status" id="status">Loading system...</div>

            <div class="video-container">
              <video id="video" autoplay muted playsinline></video>
              <canvas id="canvas"></canvas>
            </div>

            <div class="controls">
              <button class="btn btn-primary" id="startBtn" disabled>
                Start Tracking
              </button>
              <button class="btn btn-danger" id="stopBtn" disabled>
                Stop Tracking
              </button>
              <button class="btn btn-secondary" id="clearBtn">
                Clear History
              </button>
            </div>

            <div class="stats-grid">
              <div class="emotion-panel">
                <h3>üìä Analisis Emosi</h3>
                <div id="emotionData">
                  <div class="emotion-item">
                    <span class="emotion-name">üòê Neutral</span>
                    <div class="emotion-bar">
                      <div class="emotion-fill" style="width: 0%"></div>
                    </div>
                    <span class="emotion-value">0%</span>
                  </div>
                  <div class="emotion-item">
                    <span class="emotion-name">üò¢ Sad</span>
                    <div class="emotion-bar">
                      <div class="emotion-fill" style="width: 0%"></div>
                    </div>
                    <span class="emotion-value">0%</span>
                  </div>
                  <div class="emotion-item">
                    <span class="emotion-name">üò† Angry</span>
                    <div class="emotion-bar">
                      <div class="emotion-fill" style="width: 0%"></div>
                    </div>
                    <span class="emotion-value">0%</span>
                  </div>
                  <div class="emotion-item">
                    <span class="emotion-name">üòÆ Surprised</span>
                    <div class="emotion-bar">
                      <div class="emotion-fill" style="width: 0%"></div>
                    </div>
                    <span class="emotion-value">0%</span>
                  </div>
                  <div class="emotion-item">
                    <span class="emotion-name">üò® Focused</span>
                    <div class="emotion-bar">
                      <div class="emotion-fill" style="width: 0%"></div>
                    </div>
                    <span class="emotion-value">0%</span>
                  </div>
                  <div class="emotion-item">
                    <span class="emotion-name">üòä Happy</span>
                    <div class="emotion-bar">
                      <div class="emotion-fill" style="width: 0%"></div>
                    </div>
                    <span class="emotion-value">0%</span>
                  </div>
                </div>
              </div>

              <div class="face-info">
                <h3>üéØ Face Metrics</h3>
                <div class="face-metric">
                  <span>Face Detected:</span>
                  <span id="faceDetected">‚ùå</span>
                </div>
                <div class="face-metric">
                  <span>Eye Blink Rate:</span>
                  <span id="blinkRate">-</span>
                </div>
                <div class="face-metric">
                  <span>Mouth Openness:</span>
                  <span id="mouthOpen">-</span>
                </div>
                <div class="face-metric">
                  <span>Head Pose:</span>
                  <span id="headPose">-</span>
                </div>
              </div>

              <div class="history-panel">
                <h3>üìà Emotion History</h3>
                <div
                  id="historyData"
                  style="max-height: 300px; overflow-y: auto"
                >
                  <p style="text-align: center; color: #ccc">
                    There is no data...
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <nav class="bottom-nav">
          <a href="home.html" class="nav-item active1">
            <i class="fa-solid fa-house"></i>
            <span class="nav-text">Home</span>
          </a>
          <a href="records.html" class="nav-item active2">
            <i class="fa-solid fa-video"></i>
            <span class="nav-text">Records</span>
          </a>
          <a href="profile.html" class="nav-item active3">
            <i class="fa-solid fa-user"></i>
            <span class="nav-text">Profile</span>
          </a>
          <a href="tracker.html" class="nav-item active4">
            <i class="fa-solid fa-camera"></i>
            <span class="nav-text">Tracking</span>
          </a>
        </nav>
      </div>
    </main>

    <!-- Bottom Navigation -->

    <script>
      // Toggle notifications or user profile dropdown
      document
        .getElementById("notificationBtn")
        .addEventListener("click", function () {
          alert("Notifications feature coming soon!");
        });

      document
        .getElementById("profileBtn")
        .addEventListener("click", function () {
          // In a real application, this would toggle a profile dropdown
          window.location.href = "profile.html";
        });
      
        class EmotionTracker {
            constructor() {
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.isTracking = false;
                this.emotionHistory = [];
                this.faceMesh = null;
                this.camera = null;
                this.lastBlink = 0;
                this.blinkCount = 0;
                this.startTime = Date.now();
                
                this.initializeElements();
                this.initializeMediaPipe();
            }
            
            initializeElements() {
                this.startBtn = document.getElementById('startBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.clearBtn = document.getElementById('clearBtn');
                this.status = document.getElementById('status');
                this.emotionData = document.getElementById('emotionData');
                this.historyData = document.getElementById('historyData');
                
                this.startBtn.addEventListener('click', () => this.startTracking());
                this.stopBtn.addEventListener('click', () => this.stopTracking());
                this.clearBtn.addEventListener('click', () => this.clearHistory());
            }
            
            initializeMediaPipe() {
                try {
                    this.status.textContent = 'Memuat MediaPipe...';
                    this.status.className = 'status loading';
                    
                    this.faceMesh = new FaceMesh({
                        locateFile: (file) => {
                            return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
                        }
                    });
                    
                    this.faceMesh.setOptions({
                        maxNumFaces: 1,
                        refineLandmarks: true,
                        minDetectionConfidence: 0.5,
                        minTrackingConfidence: 0.5
                    });
                    
                    this.faceMesh.onResults(this.onResults.bind(this));
                    
                    this.status.textContent = 'System ready! Click "Start Tracking" to begin.';
                    this.status.className = 'status ready';
                    this.startBtn.disabled = false;
                    
                } catch (error) {
                    console.error('Error initializing MediaPipe:', error);
                    this.status.textContent = 'Failed loading system detection. Try refresh the page.';
                    this.status.className = 'status error';
                }
            }
            
            async startTracking() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { width: 640, height: 480 }
                    });
                    
                    this.video.srcObject = stream;
                    
                    this.video.addEventListener('loadedmetadata', () => {
                        this.canvas.width = this.video.videoWidth;
                        this.canvas.height = this.video.videoHeight;
                        this.canvas.style.width = this.video.offsetWidth + 'px';
                        this.canvas.style.height = this.video.offsetHeight + 'px';
                    });
                    
                    this.camera = new Camera(this.video, {
                        onFrame: async () => {
                            if (this.isTracking) {
                                await this.faceMesh.send({image: this.video});
                            }
                        },
                        width: 640,
                        height: 480
                    });
                    
                    this.camera.start();
                    this.isTracking = true;
                    this.startBtn.disabled = true;
                    this.stopBtn.disabled = false;
                    this.status.textContent = 'Tracking aktif - Lihat ke kamera!';
                    this.status.className = 'status ready';
                    this.startTime = Date.now();
                    this.blinkCount = 0;
                    
                } catch (error) {
                    console.error('Error accessing camera:', error);
                    this.status.textContent = 'Failed accses camera. Pastikan izin kamera diberikan.';
                    this.status.className = 'status error';
                }
            }
            
            stopTracking() {
                this.isTracking = false;
                
                if (this.camera) {
                    this.camera.stop();
                }
                
                if (this.video.srcObject) {
                    this.video.srcObject.getTracks().forEach(track => track.stop());
                    this.video.srcObject = null;
                }
                
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                this.startBtn.disabled = false;
                this.stopBtn.disabled = true;
                this.status.textContent = 'Tracking stoped.';
                this.status.className = 'status';
                
                // Reset face metrics
                document.getElementById('faceDetected').textContent = '‚ùå';
                document.getElementById('blinkRate').textContent = '-';
                document.getElementById('mouthOpen').textContent = '-';
                document.getElementById('headPose').textContent = '-';
            }
            
            onResults(results) {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                    const landmarks = results.multiFaceLandmarks[0];
                    
                    // Draw face landmarks
                    this.drawFaceLandmarks(landmarks);
                    
                    // Analyze emotions based on facial features
                    const emotions = this.analyzeFacialFeatures(landmarks);
                    
                    // Update displays
                    this.updateEmotionDisplay(emotions);
                    this.updateFaceMetrics(landmarks);
                    this.addToHistory(emotions);
                    
                    document.getElementById('faceDetected').textContent = '‚úÖ';
                } else {
                    document.getElementById('faceDetected').textContent = '‚ùå';
                }
            }
            
            drawFaceLandmarks(landmarks) {
                this.ctx.fillStyle = '#00ff00';
                this.ctx.strokeStyle = '#00ff00';
                this.ctx.lineWidth = 1;
                
                // Draw face contour
                this.ctx.beginPath();
                const faceContour = [10, 151, 9, 8, 168, 6, 148, 176, 149, 150, 136, 172, 58, 132, 93, 234, 127, 162, 21, 54, 103, 67, 109, 10];
                
                landmarks.forEach((landmark, index) => {
                    const x = landmark.x * this.canvas.width;
                    const y = landmark.y * this.canvas.height;
                    
                    if (faceContour.includes(index)) {
                        this.ctx.fillRect(x - 1, y - 1, 2, 2);
                    }
                });
                
                // Draw eyes
                this.drawEyes(landmarks);
                
                // Draw mouth
                this.drawMouth(landmarks);
            }
            
            drawEyes(landmarks) {
                this.ctx.fillStyle = '#ff0000';
                
                // Left eye
                const leftEye = [33, 7, 163, 144, 145, 153, 154, 155, 133, 173, 157, 158, 159, 160, 161, 246];
                leftEye.forEach(index => {
                    const point = landmarks[index];
                    const x = point.x * this.canvas.width;
                    const y = point.y * this.canvas.height;
                    this.ctx.fillRect(x - 1, y - 1, 2, 2);
                });
                
                // Right eye
                const rightEye = [362, 382, 381, 380, 374, 373, 390, 249, 263, 466, 388, 387, 386, 385, 384, 398];
                rightEye.forEach(index => {
                    const point = landmarks[index];
                    const x = point.x * this.canvas.width;
                    const y = point.y * this.canvas.height;
                    this.ctx.fillRect(x - 1, y - 1, 2, 2);
                });
            }
            
            drawMouth(landmarks) {
                this.ctx.fillStyle = '#0000ff';
                
                // Mouth outline
                const mouth = [61, 84, 17, 314, 405, 320, 307, 375, 321, 308, 324, 318, 402, 317, 14, 87, 178, 88, 95, 78, 191, 80, 81, 82, 13, 312, 311, 310, 415, 13];
                mouth.forEach(index => {
                    const point = landmarks[index];
                    const x = point.x * this.canvas.width;
                    const y = point.y * this.canvas.height;
                    this.ctx.fillRect(x - 1, y - 1, 2, 2);
                });
            }
            
            analyzeFacialFeatures(landmarks) {
                // Simple emotion analysis based on facial geometry
                const emotions = {
                    happy: 0,
                    sad: 0,
                    angry: 0,
                    surprised: 0,
                    focused: 0,
                    neutral: 0.5
                };
                
                // Mouth analysis
                const mouthLeft = landmarks[61];
                const mouthRight = landmarks[291];
                const mouthTop = landmarks[13];
                const mouthBottom = landmarks[14];
                
                const mouthWidth = Math.abs(mouthRight.x - mouthLeft.x);
                const mouthHeight = Math.abs(mouthBottom.y - mouthTop.y);
                const mouthRatio = mouthHeight / mouthWidth;
                
                // Eye analysis
                const leftEyeTop = landmarks[159];
                const leftEyeBottom = landmarks[145];
                const rightEyeTop = landmarks[386];
                const rightEyeBottom = landmarks[374];
                
                const leftEyeHeight = Math.abs(leftEyeBottom.y - leftEyeTop.y);
                const rightEyeHeight = Math.abs(rightEyeBottom.y - rightEyeTop.y);
                const avgEyeHeight = (leftEyeHeight + rightEyeHeight) / 2;
                
                // Eyebrow analysis
                const leftBrow = landmarks[70];
                const rightBrow = landmarks[107];
                const noseBridge = landmarks[9];
                
                const browHeight = Math.abs(((leftBrow.y + rightBrow.y) / 2) - noseBridge.y);
                
                // Emotion detection logic
                if (mouthRatio > 0.02 && avgEyeHeight > 0.01) {
                    emotions.surprised = Math.min(mouthRatio * 20, 1);
                }
                
                if (mouthWidth > 0.05 && mouthRatio < 0.015) {
                    emotions.happy = Math.min(mouthWidth * 10, 1);
                }
                
                if (browHeight < 0.02) {
                    emotions.angry = Math.min((0.02 - browHeight) * 30, 1);
                }
                
                if (avgEyeHeight < 0.008) {
                    emotions.focused = Math.min((0.008 - avgEyeHeight) * 50, 1);
                }
                
                if (mouthRatio < 0.01 && avgEyeHeight < 0.012) {
                    emotions.sad = Math.min((0.01 - mouthRatio) * 20, 1);
                }
                
                // Normalize emotions
                const total = Object.values(emotions).reduce((sum, val) => sum + val, 0);
                if (total > 0) {
                    Object.keys(emotions).forEach(key => {
                        emotions[key] = emotions[key] / total;
                    });
                }
                
                return emotions;
            }
            
            updateFaceMetrics(landmarks) {
                // Blink detection
                const leftEyeTop = landmarks[159];
                const leftEyeBottom = landmarks[145];
                const rightEyeTop = landmarks[386];
                const rightEyeBottom = landmarks[374];
                
                const leftEyeHeight = Math.abs(leftEyeBottom.y - leftEyeTop.y);
                const rightEyeHeight = Math.abs(rightEyeBottom.y - rightEyeTop.y);
                const avgEyeHeight = (leftEyeHeight + rightEyeHeight) / 2;
                
                if (avgEyeHeight < 0.006) {
                    const now = Date.now();
                    if (now - this.lastBlink > 200) {
                        this.blinkCount++;
                        this.lastBlink = now;
                    }
                }
                
                const timeElapsed = (Date.now() - this.startTime) / 60000; // minutes
                const blinkRate = timeElapsed > 0 ? Math.round(this.blinkCount / timeElapsed) : 0;
                
                // Mouth openness
                const mouthTop = landmarks[13];
                const mouthBottom = landmarks[14];
                const mouthOpenness = Math.abs(mouthBottom.y - mouthTop.y);
                const mouthPercent = Math.round(mouthOpenness * 1000);
                
                // Head pose (simplified)
                const noseTip = landmarks[1];
                const headPose = noseTip.x > 0.55 ? 'Right' : noseTip.x < 0.45 ? 'Left' : 'Center';
                
                // Update display
                document.getElementById('blinkRate').textContent = `${blinkRate}/min`;
                document.getElementById('mouthOpen').textContent = `${mouthPercent}%`;
                document.getElementById('headPose').textContent = headPose;
            }
            
            updateEmotionDisplay(emotions) {
                const emotionItems = this.emotionData.querySelectorAll('.emotion-item');
                const emotionNames = ['happy', 'sad', 'angry', 'surprised', 'focused', 'neutral'];
                
                emotionItems.forEach((item, index) => {
                    const emotionName = emotionNames[index];
                    const emotionValue = emotions[emotionName] || 0;
                    const percentage = Math.round(emotionValue * 100);
                    
                    item.querySelector('.emotion-fill').style.width = percentage + '%';
                    item.querySelector('.emotion-value').textContent = percentage + '%';
                });
            }
            
            addToHistory(emotions) {
                const dominant = this.getDominantEmotion(emotions);
                const timestamp = new Date().toLocaleTimeString('id-ID');
                
                this.emotionHistory.unshift({
                    timestamp,
                    dominant,
                    emotions
                });
                
                if (this.emotionHistory.length > 50) {
                    this.emotionHistory.pop();
                }
                
                this.updateHistoryDisplay();
            }
            
            getDominantEmotion(emotions) {
                let maxValue = 0;
                let dominantEmotion = 'neutral';
                
                Object.entries(emotions).forEach(([emotion, value]) => {
                    if (value > maxValue) {
                        maxValue = value;
                        dominantEmotion = emotion;
                    }
                });
                
                return {
                    name: dominantEmotion,
                    confidence: Math.round(maxValue * 100)
                };
            }
            
            updateHistoryDisplay() {
                if (this.emotionHistory.length === 0) {
                    this.historyData.innerHTML = '<p style="text-align: center; color: #ccc;">Belum ada data...</p>';
                    return;
                }
                
                const historyHTML = this.emotionHistory.slice(0, 10).map(item => `
                    <div class="history-item">
                        <span class="timestamp">${item.timestamp}</span>
                        <span class="dominant-emotion">${item.dominant.name} (${item.dominant.confidence}%)</span>
                    </div>
                `).join('');
                
                this.historyData.innerHTML = historyHTML;
            }
            
            clearHistory() {
                this.emotionHistory = [];
                this.updateHistoryDisplay();
                this.blinkCount = 0;
                this.startTime = Date.now();
            }
        }
        
        // Initialize when page loads
        window.addEventListener('load', () => {
            // Check if MediaPipe is available
            if (typeof FaceMesh !== 'undefined' && typeof Camera !== 'undefined') {
                new EmotionTracker();
            } else {
                document.getElementById('status').textContent = 'Gagal memuat MediaPipe. Coba refresh halaman.';
                document.getElementById('status').className = 'status error';
            }
        });
    </script>
  </body>
</html>
